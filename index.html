<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Koala Family Delivery</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #2d5a27;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Press Start 2P', monospace;
      color: #e8e0c8;
      padding: 12px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    h1 {
      font-size: 14px;
      margin-bottom: 12px;
      text-align: center;
      text-shadow: 2px 2px 0 #1a3516;
      line-height: 1.6;
    }

    #game-container {
      position: relative;
      background: #4a7c42;
      border: 4px solid #1a3516;
      border-radius: 4px;
      box-shadow: inset 0 0 0 2px #6b9e62, 4px 4px 0 #1a3516;
      padding: 8px;
    }

    #game-canvas {
      display: block;
      background: #5a9c50;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    #hud {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 10px;
      gap: 8px;
    }

    #score-display, #day-display, #time-display, #occupied-display {
      color: #fff8dc;
    }

    #family-queue {
      margin-top: 6px;
      padding: 6px 10px;
      background: rgba(26, 53, 22, 0.9);
      border: 2px solid #1a3516;
      border-radius: 4px;
      font-size: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #family-queue .queue-label { color: #c4d4a8; }
    #current-family { color: #a8e06c; font-weight: bold; }

    #day-transition-screen {
      display: none;
      position: absolute;
      inset: 0;
      background: rgba(26, 53, 22, 0.95);
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 15;
    }

    #day-transition-screen.visible {
      display: flex;
    }

    #day-transition-screen h2 { font-size: 12px; margin-bottom: 8px; color: #fff8dc; }
    #day-transition-screen .tt-summary { font-size: 8px; color: #c4d4a8; margin-bottom: 16px; }
    #day-transition-screen .tt-row {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 280px;
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 4px;
      font-size: 8px;
    }
    #day-transition-screen .tt-occupied { background: rgba(168, 224, 108, 0.2); color: #a8e06c; }
    #day-transition-screen .tt-empty { background: rgba(248, 113, 113, 0.2); color: #f87171; }
    #day-transition-screen .tt-penalty { background: rgba(248, 113, 113, 0.3); color: #fca5a5; }
    #day-transition-screen .tt-next { font-size: 8px; margin: 12px 0; color: #c4d4a8; }
    #day-transition-screen .pixel-btn { margin-top: 8px; }

    #win-lose-toast {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 10px;
      z-index: 12;
      display: none;
      pointer-events: none;
    }
    #win-lose-toast.show { display: block; animation: toast 2s ease; }
    #win-lose-toast.bg-green-700 { background: #15803d; color: #fff; }
    #win-lose-toast.bg-red-700 { background: #b91c1c; color: #fff; }
    #win-lose-toast.bg-gray-700 { background: #374151; color: #fff; }
    @keyframes toast { 0%, 30% { opacity: 1; } 100% { opacity: 0; } }

    #instructions {
      margin-top: 12px;
      font-size: 8px;
      text-align: center;
      line-height: 1.8;
      color: #c4d4a8;
      max-width: 480px;
    }

    /* Start screen */
    #start-screen {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(26, 53, 22, 0.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 10;
    }

    #start-screen h2 {
      font-size: 12px;
      margin-bottom: 24px;
      text-align: center;
      line-height: 1.6;
    }

    #start-screen p {
      font-size: 8px;
      margin-bottom: 20px;
      text-align: center;
      line-height: 2;
      color: #c4d4a8;
    }

    .pixel-btn {
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      padding: 12px 24px;
      background: #6b9e62;
      color: #fff8dc;
      border: 3px solid #1a3516;
      cursor: pointer;
      box-shadow: 3px 3px 0 #1a3516;
      image-rendering: pixelated;
      transition: transform 0.08s, box-shadow 0.08s;
    }

    .pixel-btn:hover {
      transform: translate(1px, 1px);
      box-shadow: 2px 2px 0 #1a3516;
    }

    .pixel-btn:active {
      transform: translate(2px, 2px);
      box-shadow: 1px 1px 0 #1a3516;
    }

    /* Game over / Leaderboard */
    #gameover-screen {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(26, 53, 22, 0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 10;
    }

    #gameover-screen.visible {
      display: flex;
    }

    #gameover-screen h2 {
      font-size: 12px;
      margin-bottom: 16px;
      color: #fff8dc;
    }

    #final-score {
      font-size: 14px;
      margin-bottom: 20px;
      color: #a8e06c;
    }

    #name-input-wrap {
      margin-bottom: 16px;
    }

    #player-name {
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      padding: 10px 16px;
      width: 220px;
      background: #e8e0c8;
      color: #1a3516;
      border: 3px solid #1a3516;
    }

    #leaderboard {
      width: 100%;
      max-width: 320px;
      margin-top: 16px;
      font-size: 8px;
      line-height: 2.2;
    }

    #leaderboard h3 {
      font-size: 10px;
      margin-bottom: 12px;
      color: #a8e06c;
    }

    .leaderboard-entry {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #3d6b35;
    }

    .leaderboard-entry.top {
      color: #ffd700;
    }
  </style>
</head>
<body>
  <h1>KOALA FAMILY DELIVERY</h1>
  <div id="game-container">
    <canvas id="game-canvas" width="512" height="384"></canvas>
    <div id="start-screen">
      <h2>BUNGALOW BLISS</h2>
      <p>
        Assign the waiting family to a bungalow. Walk within 2 steps of a house, then ENTER or SPACE.<br>
        Perfect match (beds = family size) = +10. Oversized house = fewer points. Too small = not allowed.<br>
        Fill all bungalows before time runs out. Each day gets faster!
      </p>
      <button class="pixel-btn" id="start-btn">START GAME</button>
      <button class="pixel-btn" id="view-leaderboard-btn" style="margin-top: 12px;">VIEW LEADERBOARD</button>
    </div>
    <div id="gameover-screen">
      <h2>GAME OVER</h2>
      <p id="final-score">SCORE: 0</p>
      <div id="name-input-wrap">
        <input type="text" id="player-name" placeholder="YOUR NAME" maxlength="12" />
      </div>
      <button class="pixel-btn" id="submit-score-btn">SUBMIT &amp; SEE LEADERBOARD</button>
      <div id="leaderboard">
        <h3>LEADERBOARD</h3>
        <div id="leaderboard-entries"></div>
      </div>
      <button class="pixel-btn" id="play-again-btn" style="margin-top: 16px;">PLAY AGAIN</button>
    </div>
    <div id="hud">
      <span id="day-display">DAY 1</span>
      <span id="time-display">1:30</span>
      <span id="score-display">SCORE: 0</span>
      <span id="occupied-display">0/4</span>
    </div>
    <div id="family-queue">
      <span class="queue-label">NEXT FAMILY:</span>
      <div id="current-family"><span id="current-family-size">-</span> people</div>
    </div>
    <div id="day-transition-screen">
      <h2>DAY <span id="tt-day">1</span> ENDED</h2>
      <p class="tt-summary">Time's up! Here's your summary:</p>
      <div class="tt-row tt-occupied"><span>Occupied Bungalows</span><span id="tt-occupied">0</span></div>
      <div class="tt-row tt-empty"><span>Empty Bungalows</span><span id="tt-empty">4</span></div>
      <div class="tt-row tt-penalty" id="tt-penalty-wrap"><span>Penalty</span><span id="tt-penalty">-0</span></div>
      <p class="tt-next">Day <span id="tt-next-day">2</span> will be faster!</p>
      <button class="pixel-btn" id="continue-day-btn">CONTINUE TO DAY <span id="tt-continue-day">2</span></button>
      <button class="pixel-btn" id="quit-save-btn" style="margin-top: 8px; font-size: 8px;">QUIT &amp; SAVE SCORE</button>
    </div>
    <div id="win-lose-toast"></div>
  </div>
  <p id="instructions">
    Walk to a bungalow (within 2 steps). ENTER or SPACE to assign. Perfect match = +10. Oversized house = fewer points. Too small = not allowed!
  </p>

  <script>
    (function () {
      const canvas = document.getElementById('game-canvas');
      const ctx = canvas.getContext('2d');
      const CW = 512;
      const CH = 384;
      const TILE = 32;

      const ASSETS = {
        koalaStill: 'assets/koala_still.png',
        koalaWalk: 'assets/koala_walk.png',
        houseEmpty: 'assets/house_empty.png',
        houseFull: 'assets/house_full.png',
        people: 'assets/people.png',
        bush: 'assets/bush.png',
        sun: 'assets/sun.png',
        button: 'assets/button.png'
      };

      const images = {};
      let loaded = 0;
      const toLoad = Object.keys(ASSETS).length;
      function loadImages(cb) {
        Object.entries(ASSETS).forEach(([key, path]) => {
          const img = new Image();
          img.onload = () => { loaded++; if (loaded === toLoad) cb(); };
          img.onerror = () => { loaded++; if (loaded === toLoad) cb(); };
          img.src = path;
          images[key] = img;
        });
      }

      const keys = {};
      let keyUsed = {};
      document.addEventListener('keydown', e => {
        keys[e.key] = true;
        if (e.key === ' ') e.preventDefault();
      });
      document.addEventListener('keyup', e => {
        keys[e.key] = false;
        keyUsed[e.key] = false;
      });

      const GRID_W = Math.floor(CW / TILE);
      const GRID_H = Math.floor(CH / TILE);
      const DAY_LENGTH_BASE = 90;
      const PENALTY_PER_EMPTY = 5;
      const FAMILY_COLORS = ['#4ade80', '#60a5fa', '#f472b6', '#fbbf24'];

      let gameState = {
        running: false,
        score: 0,
        day: 1,
        timeRemaining: DAY_LENGTH_BASE,
        koala: { gx: 4, gy: 5, w: TILE, h: TILE, walkFrame: 0 },
        families: [],
        bungalows: [],
        showDayTransition: false,
        gameWon: false,
        gameLost: false,
        toastUntil: 0
      };

      function makeFamily() {
        return { id: Date.now() + Math.random(), size: 1 + Math.floor(Math.random() * 4), color: FAMILY_COLORS[Math.floor(Math.random() * FAMILY_COLORS.length)] };
      }

      function seedFamilies(count) {
        for (let i = 0; i < count; i++) gameState.families.push(makeFamily());
      }

      function spawnBungalows() {
        const positions = [[2, 2], [10, 2], [2, 8], [10, 8]];
        gameState.bungalows = positions.map(([gx, gy], i) => ({
          id: 'b' + i,
          gx, gy,
          x: gx * TILE, y: gy * TILE, w: TILE * 1.5, h: TILE * 1.5,
          beds: 1 + (i % 4),
          occupied: false,
          family: null
        }));
      }

      function getCurrentFamily() {
        return gameState.families.length > 0 ? gameState.families[0] : null;
      }

      function manhattan(b, p) {
        return Math.abs(b.gx - p.gx) + Math.abs(b.gy - p.gy);
      }

      function nearbyBungalow() {
        const p = gameState.koala;
        return gameState.bungalows.find(b => !b.occupied && manhattan(b, p) <= 2);
      }

      function assignFamily() {
        const fam = getCurrentFamily();
        const b = nearbyBungalow();
        if (!fam || !b) {
          if (!b && fam) showToast('Walk closer to a bungalow!', 'info');
          return;
        }
        if (b.beds < fam.size) {
          showToast('TOO SMALL!', 'bad');
          return;
        }
        const perfect = b.beds === fam.size;
        const points = perfect ? 10 : Math.max(1, 10 - (b.beds - fam.size) * 3);
        gameState.score += points;
        b.occupied = true;
        b.family = fam;
        gameState.families.shift();
        gameState.families.push(makeFamily());

        const occupied = gameState.bungalows.filter(x => x.occupied).length;
        if (occupied === gameState.bungalows.length) {
          gameState.gameWon = true;
          showToast('All bungalows full!', 'good');
        } else {
          showToast(perfect ? '+10 Perfect!' : '+' + points, 'good');
        }
      }

      function showToast(msg, type) {
        const el = document.getElementById('win-lose-toast');
        el.textContent = msg;
        el.className = 'show ' + (type === 'good' ? 'bg-green-700' : type === 'bad' ? 'bg-red-700' : 'bg-gray-700');
        gameState.toastUntil = performance.now() + 1500;
      }

      function endDay() {
        gameState.gameLost = true;
        const occupied = gameState.bungalows.filter(b => b.occupied).length;
        const empty = gameState.bungalows.length - occupied;
        const penalty = empty * PENALTY_PER_EMPTY;
        gameState.score = Math.max(0, gameState.score - penalty);
        gameState.showDayTransition = true;
        document.getElementById('tt-day').textContent = gameState.day;
        document.getElementById('tt-occupied').textContent = occupied;
        document.getElementById('tt-empty').textContent = empty;
        document.getElementById('tt-penalty').textContent = '-' + penalty;
        document.getElementById('tt-penalty-wrap').style.display = penalty > 0 ? 'flex' : 'none';
        document.getElementById('tt-next-day').textContent = gameState.day + 1;
        document.getElementById('tt-continue-day').textContent = gameState.day + 1;
        document.getElementById('day-transition-screen').classList.add('visible');
      }

      function continueToNextDay() {
        gameState.day++;
        gameState.bungalows.forEach(b => { b.occupied = false; b.family = null; });
        gameState.families = [];
        seedFamilies(6);
        gameState.timeRemaining = Math.max(30, DAY_LENGTH_BASE - (gameState.day - 1) * 10);
        gameState.showDayTransition = false;
        gameState.gameWon = false;
        gameState.gameLost = false;
        document.getElementById('day-transition-screen').classList.remove('visible');
      }

      function endGame() {
        gameState.running = false;
        restoreGameOverScreen();
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('gameover-screen').classList.add('visible');
        document.getElementById('final-score').textContent = 'SCORE: ' + gameState.score;
        renderLeaderboard();
      }

      document.getElementById('continue-day-btn').addEventListener('click', () => {
        continueToNextDay();
      });
      document.getElementById('quit-save-btn').addEventListener('click', () => {
        document.getElementById('day-transition-screen').classList.remove('visible');
        gameState.showDayTransition = false;
        endGame();
      });

      const LEADERBOARD_KEY = 'koalaFamilyLeaderboard';
      function getLeaderboard() {
        try {
          const raw = localStorage.getItem(LEADERBOARD_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (_) { return []; }
      }
      function saveToLeaderboard(name, score) {
        const list = getLeaderboard();
        list.push({ name: (name || 'ANON').slice(0, 12).toUpperCase(), score, date: Date.now() });
        list.sort((a, b) => b.score - a.score);
        localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(list.slice(0, 10)));
      }
      function renderLeaderboard() {
        const entries = getLeaderboard();
        const html = entries.map((e, i) =>
          `<div class="leaderboard-entry ${i < 3 ? 'top' : ''}">${i + 1}. ${e.name} - ${e.score}</div>`
        ).join('') || '<div class="leaderboard-entry">No scores yet!</div>';
        document.getElementById('leaderboard-entries').innerHTML = html;
      }

      document.getElementById('submit-score-btn').addEventListener('click', () => {
        const name = document.getElementById('player-name').value.trim();
        saveToLeaderboard(name, gameState.score);
        renderLeaderboard();
      });
      document.getElementById('play-again-btn').addEventListener('click', () => {
        if (document.getElementById('play-again-btn').dataset.mode === 'back') {
          document.getElementById('gameover-screen').classList.remove('visible');
          document.getElementById('start-screen').style.display = 'flex';
          restoreGameOverScreen();
          return;
        }
        document.getElementById('gameover-screen').classList.remove('visible');
        document.getElementById('start-screen').style.display = 'flex';
        document.getElementById('player-name').value = '';
        restoreGameOverScreen();
        startGame();
      });

      function showLeaderboardOnly() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('gameover-screen').classList.add('visible');
        document.getElementById('final-score').textContent = 'LEADERBOARD';
        document.getElementById('name-input-wrap').style.display = 'none';
        document.getElementById('submit-score-btn').style.display = 'none';
        document.getElementById('play-again-btn').textContent = 'BACK';
        document.getElementById('play-again-btn').dataset.mode = 'back';
        renderLeaderboard();
      }
      function restoreGameOverScreen() {
        document.getElementById('final-score').textContent = 'SCORE: 0';
        document.getElementById('name-input-wrap').style.display = 'block';
        document.getElementById('submit-score-btn').style.display = 'block';
        document.getElementById('play-again-btn').textContent = 'PLAY AGAIN';
        document.getElementById('play-again-btn').dataset.mode = '';
      }
      document.getElementById('view-leaderboard-btn').addEventListener('click', showLeaderboardOnly);

      function startGame() {
        gameState = {
          running: true,
          score: 0,
          day: 1,
          timeRemaining: DAY_LENGTH_BASE,
          koala: { gx: 4, gy: 5, w: TILE, h: TILE, walkFrame: 0 },
          families: [],
          bungalows: [],
          showDayTransition: false,
          gameWon: false,
          gameLost: false,
          toastUntil: 0
        };
        spawnBungalows();
        seedFamilies(6);
        document.getElementById('score-display').textContent = 'SCORE: 0';
        document.getElementById('day-display').textContent = 'DAY 1';
        document.getElementById('time-display').textContent = '1:30';
        document.getElementById('occupied-display').textContent = '0/4';
      }

      document.getElementById('start-btn').addEventListener('click', () => {
        document.getElementById('start-screen').style.display = 'none';
        startGame();
      });

      const MOVE_DELAY = 120;
      let moveCooldown = 0;
      function update() {
        if (!gameState.running) return;

        if (gameState.showDayTransition) return;

        const k = gameState.koala;
        moveCooldown--;
        if (moveCooldown <= 0) {
          if (keys['ArrowUp'] || keys['w'] || keys['W']) { k.gy = Math.max(0, k.gy - 1); moveCooldown = MOVE_DELAY; k.walkFrame = (k.walkFrame + 1) % 20; }
          else if (keys['ArrowDown'] || keys['s'] || keys['S']) { k.gy = Math.min(GRID_H - 1, k.gy + 1); moveCooldown = MOVE_DELAY; k.walkFrame = (k.walkFrame + 1) % 20; }
          else if (keys['ArrowLeft'] || keys['a'] || keys['A']) { k.gx = Math.max(0, k.gx - 1); moveCooldown = MOVE_DELAY; k.walkFrame = (k.walkFrame + 1) % 20; }
          else if (keys['ArrowRight'] || keys['d'] || keys['D']) { k.gx = Math.min(GRID_W - 1, k.gx + 1); moveCooldown = MOVE_DELAY; k.walkFrame = (k.walkFrame + 1) % 20; }
        }

        if ((keys[' '] || keys['Enter']) && !keyUsed[' '] && !keyUsed['Enter']) {
          keyUsed[' '] = true;
          keyUsed['Enter'] = true;
          assignFamily();
        }

        gameState.timeRemaining -= 1 / 60;
        if (gameState.timeRemaining <= 0 && !gameState.showDayTransition) endDay();

        const occupied = gameState.bungalows.filter(b => b.occupied).length;
        const total = gameState.bungalows.length;
        const t = Math.max(0, gameState.timeRemaining);
        const mins = Math.floor(t / 60);
        const secs = Math.floor(t % 60);

        document.getElementById('score-display').textContent = 'SCORE: ' + gameState.score;
        document.getElementById('day-display').textContent = 'DAY ' + gameState.day;
        document.getElementById('time-display').textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
        document.getElementById('occupied-display').textContent = occupied + '/' + total;
        const cf = getCurrentFamily();
        document.getElementById('current-family-size').textContent = cf ? cf.size : '-';

        if (gameState.toastUntil > 0 && performance.now() > gameState.toastUntil) {
          document.getElementById('win-lose-toast').classList.remove('show');
        }
      }

      function draw() {
        ctx.fillStyle = '#5a9c50';
        ctx.fillRect(0, 0, CW, CH);

        if (images.sun && images.sun.complete && images.sun.naturalWidth) {
          ctx.drawImage(images.sun, CW - 80, 8, 64, 64);
        }
        if (images.bush && images.bush.complete) {
          ctx.drawImage(images.bush, 8, CH - 48, 48, 48);
          ctx.drawImage(images.bush, CW - 56, CH - 48, 48, 48);
        }

        gameState.bungalows.forEach(b => {
          const img = b.occupied && images.houseFull && images.houseFull.complete ? images.houseFull : images.houseEmpty;
          if (img && img.complete && img.naturalWidth) {
            ctx.drawImage(img, b.x, b.y, b.w, b.h);
          } else {
            ctx.fillStyle = b.occupied ? '#6b8e6a' : '#7a9c8a';
            ctx.fillRect(b.x, b.y, b.w, b.h);
          }
          ctx.fillStyle = '#1a3516';
          ctx.font = '12px "Press Start 2P"';
          ctx.fillText(String(b.beds), b.x + b.w / 2 - 6, b.y + b.h / 2 + 4);
        });

        const k = gameState.koala;
        const kx = k.gx * TILE, ky = k.gy * TILE;
        const koalaImg = (k.walkFrame < 10 && images.koalaWalk && images.koalaWalk.complete) ? images.koalaWalk : images.koalaStill;
        if (koalaImg && koalaImg.complete && koalaImg.naturalWidth) {
          ctx.drawImage(koalaImg, kx, ky, k.w, k.h);
        } else {
          ctx.fillStyle = '#8b9c7a';
          ctx.fillRect(kx, ky, k.w, k.h);
        }
      }

      function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
      }

      loadImages(() => {
        loop();
      });
    })();
  </script>
</body>
</html>
