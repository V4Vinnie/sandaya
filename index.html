<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Koala Family Delivery</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #2d5a27;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: 'Press Start 2P', monospace;
      color: #e8e0c8;
      padding: 12px;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    h1 {
      font-size: 14px;
      margin-bottom: 12px;
      text-align: center;
      text-shadow: 2px 2px 0 #1a3516;
      line-height: 1.6;
    }

    #game-container {
      position: relative;
      background: #4a7c42;
      border: 4px solid #1a3516;
      border-radius: 4px;
      box-shadow: inset 0 0 0 2px #6b9e62, 4px 4px 0 #1a3516;
      padding: 8px;
    }

    #game-canvas {
      display: block;
      background: #5a9c50;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }

    #hud {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-top: 8px;
      font-size: 10px;
      gap: 8px;
    }

    #score-display, #day-display, #time-display, #occupied-display {
      color: #fff8dc;
    }

    #family-queue {
      margin-top: 6px;
      padding: 6px 10px;
      background: rgba(26, 53, 22, 0.9);
      border: 2px solid #1a3516;
      border-radius: 4px;
      font-size: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #family-queue .queue-label { color: #c4d4a8; }
    #current-family { color: #a8e06c; font-weight: bold; display: flex; align-items: center; gap: 6px; }
    #current-family-people { display: flex; align-items: center; gap: 2px; }
    #current-family-people img { width: 20px; height: 20px; image-rendering: pixelated; image-rendering: crisp-edges; }

    #day-transition-screen {
      display: none;
      position: absolute;
      inset: 0;
      background: rgba(26, 53, 22, 0.95);
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 15;
    }

    #day-transition-screen.visible {
      display: flex;
    }

    #day-transition-screen h2 { font-size: 12px; margin-bottom: 8px; color: #fff8dc; }
    #day-transition-screen .tt-summary { font-size: 8px; color: #c4d4a8; margin-bottom: 16px; }
    #day-transition-screen .tt-row {
      display: flex;
      justify-content: space-between;
      width: 100%;
      max-width: 280px;
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 4px;
      font-size: 8px;
    }
    #day-transition-screen .tt-occupied { background: rgba(168, 224, 108, 0.2); color: #a8e06c; }
    #day-transition-screen .tt-empty { background: rgba(248, 113, 113, 0.2); color: #f87171; }
    #day-transition-screen .tt-penalty { background: rgba(248, 113, 113, 0.3); color: #fca5a5; }
    #day-transition-screen .tt-next { font-size: 8px; margin: 12px 0; color: #c4d4a8; }
    #day-transition-screen .pixel-btn { margin-top: 8px; }

    #win-lose-toast {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 10px;
      z-index: 12;
      display: none;
      pointer-events: none;
    }
    #win-lose-toast.show { display: block; animation: toast 2s ease; }
    #win-lose-toast.bg-green-700 { background: #15803d; color: #fff; }
    #win-lose-toast.bg-red-700 { background: #b91c1c; color: #fff; }
    #win-lose-toast.bg-gray-700 { background: #374151; color: #fff; }
    @keyframes toast { 0%, 30% { opacity: 1; } 100% { opacity: 0; } }

    #instructions {
      margin-top: 12px;
      font-size: 8px;
      text-align: center;
      line-height: 1.8;
      color: #c4d4a8;
      max-width: 480px;
    }

    /* Start screen */
    #start-screen {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(26, 53, 22, 0.92);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 10;
    }

    #start-screen h2 {
      font-size: 12px;
      margin-bottom: 24px;
      text-align: center;
      line-height: 1.6;
    }

    #start-screen p {
      font-size: 8px;
      margin-bottom: 20px;
      text-align: center;
      line-height: 2;
      color: #c4d4a8;
    }

    .pixel-btn {
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      padding: 12px 24px;
      background: #6b9e62;
      color: #fff8dc;
      border: 3px solid #1a3516;
      cursor: pointer;
      box-shadow: 3px 3px 0 #1a3516;
      image-rendering: pixelated;
      transition: transform 0.08s, box-shadow 0.08s;
    }

    .pixel-btn:hover {
      transform: translate(1px, 1px);
      box-shadow: 2px 2px 0 #1a3516;
    }

    .pixel-btn:active {
      transform: translate(2px, 2px);
      box-shadow: 1px 1px 0 #1a3516;
    }

    /* Game over / Leaderboard */
    #gameover-screen {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(26, 53, 22, 0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 10;
    }

    #gameover-screen.visible {
      display: flex;
    }

    #gameover-screen h2 {
      font-size: 12px;
      margin-bottom: 16px;
      color: #fff8dc;
    }

    #final-score {
      font-size: 14px;
      margin-bottom: 20px;
      color: #a8e06c;
    }

    #name-input-wrap {
      margin-bottom: 16px;
    }

    #player-name {
      font-family: 'Press Start 2P', monospace;
      font-size: 10px;
      padding: 10px 16px;
      width: 220px;
      background: #e8e0c8;
      color: #1a3516;
      border: 3px solid #1a3516;
    }

    #leaderboard {
      width: 100%;
      max-width: 320px;
      margin-top: 16px;
      font-size: 8px;
      line-height: 2.2;
    }

    #leaderboard h3 {
      font-size: 10px;
      margin-bottom: 12px;
      color: #a8e06c;
    }

    .leaderboard-entry {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #3d6b35;
    }

    .leaderboard-entry.top {
      color: #ffd700;
    }

    /* Storyboard: Welcome screen */
    #welcome-screen {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #7cb86a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 20;
    }
    #welcome-screen.hide { display: none; }
    #welcome-screen .welcome-title {
      font-size: 14px;
      color: #1a3516;
      margin-bottom: 12px;
      text-shadow: 1px 1px 0 rgba(255,255,255,0.5);
    }
    #welcome-screen .welcome-koala-wrap {
      margin: 8px 0;
      position: relative;
    }
    #welcome-screen .welcome-koala-wrap img { image-rendering: pixelated; width: 80px; height: 80px; }
    #welcome-screen .welcome-deco {
      position: absolute;
      image-rendering: pixelated;
    }
    #welcome-screen .welcome-deco.house-l { left: -60px; top: 20px; width: 48px; height: 48px; }
    #welcome-screen .welcome-deco.house-r { right: -60px; top: 20px; width: 48px; height: 48px; }
    #welcome-screen .welcome-deco.bush { width: 32px; height: 32px; }
    #welcome-screen .welcome-jouer {
      margin-top: 16px;
      font-size: 12px;
      padding: 14px 32px;
      background: #c4a574;
      color: #1a3516;
      border: 3px solid #1a3516;
      box-shadow: 3px 3px 0 #1a3516;
    }
    #welcome-screen .welcome-footer {
      position: absolute;
      bottom: 12px;
      left: 0; right: 0;
      display: flex;
      justify-content: space-between;
      padding: 0 16px;
      font-size: 8px;
      color: #3d6b35;
    }

    /* Storyboard: How to Play */
    #how-to-play-screen {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #7cb86a;
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      z-index: 19;
      overflow-y: auto;
    }
    #how-to-play-screen.visible { display: flex; }
    #how-to-play-screen .htp-title { font-size: 12px; color: #1a3516; margin-bottom: 12px; }
    #how-to-play-screen .htp-panels {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      max-width: 400px;
      margin-bottom: 10px;
    }
    #how-to-play-screen .htp-panel {
      background: #e8e0c8;
      border: 3px solid #1a3516;
      border-radius: 6px;
      padding: 10px;
      font-size: 8px;
      color: #1a3516;
    }
    #how-to-play-screen .htp-panel.wide { grid-column: 1 / -1; }
    #how-to-play-screen .htp-panel strong { display: block; margin-bottom: 4px; }
    #how-to-play-screen .htp-panel img { display: block; margin-top: 4px; image-rendering: pixelated; }
    #how-to-play-screen .htp-scoring {
      background: #e8e0c8;
      border: 3px solid #1a3516;
      border-radius: 6px;
      padding: 10px;
      font-size: 8px;
      color: #1a3516;
      margin-bottom: 12px;
      width: 100%; max-width: 400px;
    }
    #how-to-play-screen .htp-scoring .row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    #how-to-play-screen .htp-commencer { font-size: 10px; padding: 12px 28px; }
    #how-to-play-screen .htp-footer { margin-top: auto; font-size: 8px; color: #3d6b35; }

    /* Language selection */
    #language-screen {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #7cb86a;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 21;
    }
    #language-screen.visible { display: flex; }
    #language-screen .lang-title { font-size: 12px; color: #1a3516; margin-bottom: 20px; text-shadow: 1px 1px 0 rgba(255,255,255,0.5); }
    #language-screen .lang-buttons { display: flex; flex-direction: column; gap: 12px; align-items: center; }

    /* Storyboard: Game Over */
    #gameover-screen .go-title { color: #b91c1c; text-shadow: 2px 2px 0 #1a3516; font-size: 14px; }
    #gameover-screen .go-koala-wrap { margin: 8px 0; }
    #gameover-screen .go-koala-wrap img { width: 64px; height: 64px; image-rendering: pixelated; }
    #gameover-screen .go-footer { margin-top: auto; font-size: 8px; color: #3d6b35; display: flex; justify-content: space-between; width: 100%; padding: 0 8px; }

    /* Storyboard: Leaderboard */
    #leaderboard-screen {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #7cb86a;
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 12px;
      z-index: 18;
      overflow-y: auto;
    }
    #leaderboard-screen.visible { display: flex; }
    #leaderboard-screen .lb-koala-wrap { margin-bottom: 8px; }
    #leaderboard-screen .lb-koala-wrap img { width: 64px; height: 64px; image-rendering: pixelated; }
    #leaderboard-screen .lb-list { width: 100%; max-width: 320px; font-size: 8px; line-height: 2; color: #1a3516; }
    #leaderboard-screen .lb-entry { display: flex; justify-content: space-between; padding: 4px 8px; border-radius: 4px; }
    #leaderboard-screen .lb-entry.current { background: rgba(168, 224, 108, 0.6); }
    #leaderboard-screen .lb-entry.top3 { color: #b45309; }
    #leaderboard-screen .lb-buttons { margin-top: 16px; display: flex; flex-direction: column; gap: 8px; align-items: center; }
    #leaderboard-screen .lb-link { font-size: 8px; color: #1a3516; cursor: pointer; text-decoration: underline; }

    /* Gameplay: progress bar (storyboard) */
    #game-progress-wrap {
      position: absolute;
      top: 8px;
      left: 8px;
      right: 8px;
      height: 16px;
      background: #1a3516;
      border-radius: 4px;
      overflow: hidden;
      z-index: 5;
    }
    #game-progress-fill {
      height: 100%;
      background: #fbbf24;
      border-radius: 2px;
      transition: width 0.2s linear;
    }
    #game-multiplier {
      position: absolute;
      bottom: 48px;
      right: 12px;
      font-size: 12px;
      color: #f59e0b;
      z-index: 5;
      display: none;
    }
    #game-multiplier.show { display: block; }
  </style>
</head>
<body>
  <h1>KOALA FAMILY DELIVERY</h1>
  <div id="game-container">
    <canvas id="game-canvas" width="512" height="384"></canvas>

    <!-- Storyboard: Welcome -->
    <div id="welcome-screen">
      <div class="welcome-title" data-i18n="welcome_title">BIENVENUE!</div>
      <div class="welcome-koala-wrap">
        <img id="welcome-koala-img" src="assets/koala_wave.png" alt="" />
        <img class="welcome-deco house-l" src="assets/house_empty.png" alt="" />
        <img class="welcome-deco house-r" src="assets/house_empty.png" alt="" />
      </div>
      <button class="pixel-btn welcome-jouer" id="welcome-play-btn" data-i18n="start_btn">START</button>
      <span class="lb-link" id="welcome-scores-link" style="margin-top: 8px; font-size: 8px;" data-i18n="view_scores">VOIR SCORES</span>
      <div class="welcome-footer">
        <span>SANDAYA</span>
        <span>Maxxton</span>
      </div>
    </div>

    <!-- Language selection -->
    <div id="language-screen">
      <div class="lang-title" data-i18n="choose_language">Choose language</div>
      <div class="lang-buttons">
        <button class="pixel-btn" id="lang-en-btn">English</button>
        <button class="pixel-btn" id="lang-fr-btn">Français</button>
      </div>
    </div>

    <!-- Storyboard: How to Play -->
    <div id="how-to-play-screen">
      <div class="htp-title" data-i18n="how_to_play_title">COMMENT JOUER</div>
      <div class="htp-panels">
        <div class="htp-panel">
          <strong data-i18n="htp_move">se déplacer</strong>
          <span data-i18n="htp_move_desc">WASD / Arrows to move</span>
          <img src="assets/tap.png" alt="" width="32" height="32" />
        </div>
        <div class="htp-panel">
          <strong data-i18n="htp_assign">accueillir les invités</strong>
          <span data-i18n="htp_assign_desc">Assign family to bungalow</span>
          <img src="assets/people.png" alt="" width="32" height="32" />
        </div>
        <div class="htp-panel wide">
          <strong data-i18n="htp_guide">guide to their stay</strong>
          <span data-i18n="htp_guide_desc">Walk to house, ENTER/SPACE to assign. Match family size to beds!</span>
        </div>
      </div>
      <div class="htp-scoring">
        <div class="row"><span data-i18n="score_perfect">correspondance parfaite</span> <span>+10</span></div>
        <div class="row"><span data-i18n="score_match">correspondance</span> <span>+5</span></div>
        <div class="row"><span data-i18n="score_speed">bonus de rapidité</span> <span>+2</span></div>
        <div class="row"><span data-i18n="score_combo">combo</span> <span>X2</span></div>
        <div class="row"><span data-i18n="score_all_full">tout complet</span> <span>+50</span></div>
      </div>
      <button class="pixel-btn htp-commencer" id="htp-start-btn" data-i18n="htp_start_btn">COMMENCER</button>
      <div class="htp-footer">SANDAYA &bull; Maxxton</div>
    </div>

    <!-- Storyboard: Leaderboard (standalone) -->
    <div id="leaderboard-screen">
      <div class="lb-koala-wrap">
        <img src="assets/koala_wave.png" alt="" width="64" height="64" />
      </div>
      <div class="lb-list" id="leaderboard-screen-entries"></div>
      <div class="lb-buttons">
        <button class="pixel-btn" id="lb-rejouer-btn" data-i18n="play_again">REJOUER</button>
        <span class="lb-link" id="lb-comment-jouer" data-i18n="how_to_play_link">comment jouer</span>
      </div>
    </div>

    <div id="start-screen" class="hide">
      <button class="pixel-btn" id="start-btn" data-i18n="start_game_btn">START GAME</button>
    </div>
    <div id="gameover-screen">
      <h2 class="go-title" data-i18n="game_over_title">FIN DE PARTIE</h2>
      <div class="go-koala-wrap">
        <img id="gameover-koala-img" src="assets/koala_wave.png" alt="" />
      </div>
      <p id="final-score">0</p>
      <div id="name-input-wrap">
        <input type="text" id="player-name" data-i18n-placeholder="name_placeholder" placeholder="nom" maxlength="12" />
      </div>
      <button class="pixel-btn" id="submit-score-btn" data-i18n="submit_btn">VALIDER</button>
      <div id="leaderboard">
        <h3 data-i18n="best_scores">MEILLEURS SCORES</h3>
        <div id="leaderboard-entries"></div>
      </div>
      <button class="pixel-btn" id="play-again-btn" style="margin-top: 16px;" data-i18n="play_again">REJOUER</button>
      <div class="go-footer">
        <span>SANDAYA</span>
        <span>Maxxton</span>
      </div>
    </div>
    <div id="hud">
      <span id="day-display">DAY 1</span>
      <span id="time-display">1:30</span>
      <span id="score-display">SCORE: 0</span>
      <span id="occupied-display">0/4</span>
    </div>
    <div id="family-queue">
      <span class="queue-label" data-i18n="next_family">NEXT FAMILY:</span>
      <div id="current-family">
        <div id="current-family-people"></div>
        <span id="current-family-size">-</span>
      </div>
    </div>
    <div id="day-transition-screen">
      <h2><span data-i18n="day">DAY</span> <span id="tt-day">1</span> <span data-i18n="day_ended">ENDED</span></h2>
      <p class="tt-summary" data-i18n="times_up_summary">Time's up! Here's your summary:</p>
      <div class="tt-row tt-occupied"><span data-i18n="occupied_bungalows">Occupied Bungalows</span><span id="tt-occupied">0</span></div>
      <div class="tt-row tt-empty"><span data-i18n="empty_bungalows">Empty Bungalows</span><span id="tt-empty">4</span></div>
      <div class="tt-row tt-penalty" id="tt-penalty-wrap"><span data-i18n="penalty">Penalty</span><span id="tt-penalty">-0</span></div>
      <p class="tt-next"><span data-i18n="day">Day</span> <span id="tt-next-day">2</span> <span data-i18n="will_be_faster">will be faster!</span></p>
      <button class="pixel-btn" id="continue-day-btn"><span data-i18n="continue_to_day">CONTINUE TO DAY</span> <span id="tt-continue-day">2</span></button>
      <button class="pixel-btn" id="quit-save-btn" style="margin-top: 8px; font-size: 8px;" data-i18n="quit_save">QUIT &amp; SAVE SCORE</button>
    </div>
    <div id="game-progress-wrap" style="display: none;">
      <div id="game-progress-fill" style="width: 100%;"></div>
    </div>
    <div id="game-multiplier">x2</div>
    <div id="win-lose-toast"></div>
  </div>
  <p id="instructions" data-i18n="instructions_text">
    Walk to a bungalow (within 2 steps). ENTER or SPACE to assign. Perfect match = +10. Oversized house = fewer points. Too small = not allowed!
  </p>

  <script>
    (function () {
      const canvas = document.getElementById('game-canvas');
      const ctx = canvas.getContext('2d');
      const CW = 512;
      const CH = 384;
      const TILE = 32;
      const WW = 1024;
      const WH = 768;

      const LANG_KEY = 'koalaFamilyLang';
      const TRANSLATIONS = {
        en: {
          choose_language: 'Choose language',
          welcome_title: 'WELCOME!',
          start_btn: 'START',
          view_scores: 'VIEW SCORES',
          how_to_play_title: 'HOW TO PLAY',
          how_to_play_link: 'how to play',
          htp_move: 'move',
          htp_move_desc: 'WASD / Arrows to move',
          htp_assign: 'welcome guests',
          htp_assign_desc: 'Assign family to bungalow',
          htp_guide: 'guide to their stay',
          htp_guide_desc: 'Walk to house, ENTER/SPACE to assign. Match family size to beds!',
          score_perfect: 'perfect match',
          score_match: 'match',
          score_speed: 'speed bonus',
          score_combo: 'combo',
          score_all_full: 'all full',
          htp_start_btn: 'START',
          start_game_btn: 'START GAME',
          play_again: 'PLAY AGAIN',
          game_over_title: 'GAME OVER',
          name_placeholder: 'name',
          submit_btn: 'SUBMIT',
          best_scores: 'BEST SCORES',
          next_family: 'NEXT FAMILY:',
          day: 'DAY',
          day_ended: 'ENDED',
          times_up_summary: "Time's up! Here's your summary:",
          occupied_bungalows: 'Occupied Bungalows',
          empty_bungalows: 'Empty Bungalows',
          penalty: 'Penalty',
          will_be_faster: 'will be faster!',
          continue_to_day: 'CONTINUE TO DAY',
          quit_save: 'QUIT & SAVE SCORE',
          instructions_text: 'Walk to a bungalow (within 2 steps). ENTER or SPACE to assign. Perfect match = +10. Oversized house = fewer points. Too small = not allowed!',
          toast_walk_closer: 'Walk closer to a bungalow!',
          toast_too_small: 'TOO SMALL!',
          toast_all_full: 'All bungalows full!',
          toast_perfect: 'Perfect!',
          no_scores_yet: 'No scores yet!',
          score_label: 'SCORE',
          occupied_label: 'occupied'
        },
        fr: {
          choose_language: 'Choisir la langue',
          welcome_title: 'BIENVENUE!',
          start_btn: 'DÉMARRER',
          view_scores: 'VOIR LES SCORES',
          how_to_play_title: 'COMMENT JOUER',
          how_to_play_link: 'comment jouer',
          htp_move: 'se déplacer',
          htp_move_desc: 'ZQSD / Flèches pour bouger',
          htp_assign: 'accueillir les invités',
          htp_assign_desc: 'Attribuer la famille au bungalow',
          htp_guide: 'guide vers leur séjour',
          htp_guide_desc: 'Marchez jusqu\'à la maison, ENTRÉE/ESPACE pour attribuer. Taille famille = nombre de lits!',
          score_perfect: 'correspondance parfaite',
          score_match: 'correspondance',
          score_speed: 'bonus de rapidité',
          score_combo: 'combo',
          score_all_full: 'tout complet',
          htp_start_btn: 'COMMENCER',
          start_game_btn: 'JOUER',
          play_again: 'REJOUER',
          game_over_title: 'FIN DE PARTIE',
          name_placeholder: 'nom',
          submit_btn: 'VALIDER',
          best_scores: 'MEILLEURS SCORES',
          next_family: 'PROCHAINE FAMILLE:',
          day: 'JOUR',
          day_ended: 'TERMINÉ',
          times_up_summary: 'Temps écoulé! Résumé:',
          occupied_bungalows: 'Bungalows occupés',
          empty_bungalows: 'Bungalows vides',
          penalty: 'Pénalité',
          will_be_faster: 'sera plus rapide!',
          continue_to_day: 'CONTINUER JOUR',
          quit_save: 'QUITTER ET SAUVEGARDER',
          instructions_text: 'Marchez jusqu\'à un bungalow (à 2 pas). ENTRÉE ou ESPACE pour attribuer. Correspondance parfaite = +10. Maison trop grande = moins de points. Trop petit = interdit!',
          toast_walk_closer: 'Approchez-vous d\'un bungalow!',
          toast_too_small: 'TROP PETIT!',
          toast_all_full: 'Tous les bungalows pleins!',
          toast_perfect: 'Parfait!',
          no_scores_yet: 'Aucun score pour l\'instant!',
          score_label: 'SCORE',
          occupied_label: 'occupés'
        }
      };
      function getLang() {
        var saved = (typeof localStorage !== 'undefined' && localStorage.getItem(LANG_KEY)) || '';
        return (saved === 'fr' || saved === 'en') ? saved : null;
      }
      function setLang(lang) {
        if (lang !== 'en' && lang !== 'fr') return;
        if (typeof localStorage !== 'undefined') localStorage.setItem(LANG_KEY, lang);
        currentLang = lang;
        applyTranslations();
      }
      var currentLang = getLang();
        if (!currentLang) currentLang = 'en';
      function t(key) {
        var L = TRANSLATIONS[currentLang];
        return (L && L[key]) || TRANSLATIONS.en[key] || key;
      }
      function applyTranslations() {
        document.querySelectorAll('[data-i18n]').forEach(function (el) {
          var key = el.getAttribute('data-i18n');
          if (key) el.textContent = t(key);
        });
        document.querySelectorAll('[data-i18n-placeholder]').forEach(function (el) {
          var key = el.getAttribute('data-i18n-placeholder');
          if (key) el.placeholder = t(key);
        });
      }
      applyTranslations();

      const ASSETS = {
        koalaStill: 'assets/koala_still.png',
        koalaWalk: 'assets/koala_walk.png',
        houseEmpty: 'assets/house_empty.png',
        houseFull: 'assets/house_full.png',
        people: 'assets/people.png',
        bush: 'assets/bush.png',
        sun: 'assets/sun.png',
        button: 'assets/button.png'
      };

      const images = {};
      let loaded = 0;
      const toLoad = Object.keys(ASSETS).length;
      function loadImages(cb) {
        Object.entries(ASSETS).forEach(([key, path]) => {
          const img = new Image();
          img.onload = () => { loaded++; if (loaded === toLoad) cb(); };
          img.onerror = () => { loaded++; if (loaded === toLoad) cb(); };
          img.src = path;
          images[key] = img;
        });
      }

      const keys = {};
      let keyUsed = {};
      document.addEventListener('keydown', e => {
        keys[e.key] = true;
        if (e.key === ' ') e.preventDefault();
      });
      document.addEventListener('keyup', e => {
        keys[e.key] = false;
        keyUsed[e.key] = false;
      });

      const GRID_W = Math.floor(WW / TILE);
      const GRID_H = Math.floor(WH / TILE);
      const DAY_LENGTH_BASE = 90;
      const PENALTY_PER_EMPTY = 5;
      const FAMILY_COLORS = ['#4ade80', '#60a5fa', '#f472b6', '#fbbf24'];

      let gameState = {
        running: false,
        score: 0,
        day: 1,
        timeRemaining: DAY_LENGTH_BASE,
        currentDayLength: DAY_LENGTH_BASE,
        koala: { x: WW / 2 - TILE / 2, y: WH / 2 - TILE / 2, gx: 0, gy: 0, w: TILE, h: TILE, walkFrame: 0, lastDir: 'down' },
        families: [],
        bungalows: [],
        showDayTransition: false,
        gameWon: false,
        gameLost: false,
        toastUntil: 0,
        combo: 0,
        multiplierUntil: 0
      };

      function makeFamily() {
        return { id: Date.now() + Math.random(), size: 1 + Math.floor(Math.random() * 4), color: FAMILY_COLORS[Math.floor(Math.random() * FAMILY_COLORS.length)] };
      }

      function seedFamilies(count) {
        for (let i = 0; i < count; i++) gameState.families.push(makeFamily());
      }

      function spawnBungalows() {
        var gw = GRID_W - 3, gh = GRID_H - 3;
        var midX = Math.floor(GRID_W / 2), midY = Math.floor(GRID_H / 2);
        var positions = [
          [2, 2], [gw, 2], [2, gh], [gw, gh],
          [midX, 2], [midX, gh], [2, midY], [gw, midY],
          [8, 8], [gw - 6, 8], [8, gh - 6], [gw - 6, gh - 6],
          [midX, midY]
        ];
        gameState.bungalows = positions.map(([gx, gy], i) => ({
          id: 'b' + i,
          gx, gy,
          x: gx * TILE, y: gy * TILE, w: TILE * 1.5, h: TILE * 1.5,
          beds: 1 + (i % 4),
          occupied: false,
          family: null
        }));
      }

      function getCurrentFamily() {
        return gameState.families.length > 0 ? gameState.families[0] : null;
      }

      function getAssignRadius(b) {
        var houseRadius = Math.max(b.w, b.h) / 2;
        return houseRadius + 72;
      }

      function distanceToBungalow(b) {
        var k = gameState.koala;
        var bx = b.x + b.w / 2, by = b.y + b.h / 2;
        var kx = k.x + k.w / 2, ky = k.y + k.h / 2;
        return Math.sqrt((bx - kx) * (bx - kx) + (by - ky) * (by - ky));
      }

      function nearbyBungalow() {
        return gameState.bungalows.find(function(b) {
          return !b.occupied && distanceToBungalow(b) <= getAssignRadius(b);
        });
      }

      function assignFamily() {
        const fam = getCurrentFamily();
        const b = nearbyBungalow();
        if (!fam || !b) {
          if (!b && fam) showToast(t('toast_walk_closer'), 'info');
          return;
        }
        if (b.beds < fam.size) {
          showToast(t('toast_too_small'), 'bad');
          return;
        }
        const perfect = b.beds === fam.size;
        if (perfect) gameState.combo++; else gameState.combo = 0;
        const mult = gameState.combo >= 2 ? 2 : 1;
        gameState.multiplierUntil = performance.now() + 2000;
        let points = perfect ? 10 : Math.max(1, 10 - (b.beds - fam.size) * 3);
        points *= mult;
        gameState.score += points;
        b.occupied = true;
        b.family = fam;
        gameState.families.shift();
        gameState.families.push(makeFamily());

        const occupied = gameState.bungalows.filter(x => x.occupied).length;
        if (occupied === gameState.bungalows.length) {
          gameState.gameWon = true;
          showToast(t('toast_all_full'), 'good');
        } else {
          showToast((perfect ? '+10 ' + t('toast_perfect') + '!' : '+' + (points / mult)) + (mult > 1 ? ' x2!' : ''), 'good');
        }
      }

      function showToast(msg, type) {
        const el = document.getElementById('win-lose-toast');
        el.textContent = msg;
        el.className = 'show ' + (type === 'good' ? 'bg-green-700' : type === 'bad' ? 'bg-red-700' : 'bg-gray-700');
        gameState.toastUntil = performance.now() + 1500;
      }

      function endDay() {
        gameState.gameLost = true;
        const occupied = gameState.bungalows.filter(b => b.occupied).length;
        const empty = gameState.bungalows.length - occupied;
        const penalty = empty * PENALTY_PER_EMPTY;
        gameState.score = Math.max(0, gameState.score - penalty);
        gameState.showDayTransition = true;
        document.getElementById('tt-day').textContent = gameState.day;
        document.getElementById('tt-occupied').textContent = occupied;
        document.getElementById('tt-empty').textContent = empty;
        document.getElementById('tt-penalty').textContent = '-' + penalty;
        document.getElementById('tt-penalty-wrap').style.display = penalty > 0 ? 'flex' : 'none';
        document.getElementById('tt-next-day').textContent = gameState.day + 1;
        document.getElementById('tt-continue-day').textContent = gameState.day + 1;
        document.getElementById('day-transition-screen').classList.add('visible');
      }

      function continueToNextDay() {
        gameState.day++;
        gameState.bungalows.forEach(b => { b.occupied = false; b.family = null; });
        gameState.families = [];
        seedFamilies(6);
        gameState.currentDayLength = Math.max(30, DAY_LENGTH_BASE - (gameState.day - 1) * 10);
        gameState.timeRemaining = gameState.currentDayLength;
        gameState.showDayTransition = false;
        gameState.gameWon = false;
        gameState.gameLost = false;
        document.getElementById('day-transition-screen').classList.remove('visible');
      }

      function endGame() {
        gameState.running = false;
        restoreGameOverScreen();
        document.getElementById('gameover-screen').classList.add('visible');
        document.getElementById('final-score').textContent = gameState.score;
        var prog = document.getElementById('game-progress-wrap');
        if (prog) prog.style.display = 'none';
        renderLeaderboard();
      }

      document.getElementById('continue-day-btn').addEventListener('click', () => {
        continueToNextDay();
      });
      document.getElementById('quit-save-btn').addEventListener('click', () => {
        document.getElementById('day-transition-screen').classList.remove('visible');
        gameState.showDayTransition = false;
        endGame();
      });

      const LEADERBOARD_KEY = 'koalaFamilyLeaderboard';
      function getLeaderboard() {
        try {
          const raw = localStorage.getItem(LEADERBOARD_KEY);
          return raw ? JSON.parse(raw) : [];
        } catch (_) { return []; }
      }
      function saveToLeaderboard(name, score) {
        const list = getLeaderboard();
        list.push({ name: (name || 'ANON').slice(0, 12).toUpperCase(), score, date: Date.now() });
        list.sort((a, b) => b.score - a.score);
        localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(list.slice(0, 10)));
      }
      function renderLeaderboard() {
        const entries = getLeaderboard();
        const html = entries.map((e, i) =>
          `<div class="leaderboard-entry ${i < 3 ? 'top' : ''}">${i + 1}. ${e.name} - ${e.score}</div>`
        ).join('') || '<div class="leaderboard-entry">' + t('no_scores_yet') + '</div>';
        document.getElementById('leaderboard-entries').innerHTML = html;
      }

      document.getElementById('submit-score-btn').addEventListener('click', () => {
        var nameInput = document.getElementById('player-name');
        var name = nameInput.value.trim();
        saveToLeaderboard(name, gameState.score);
        renderLeaderboard();
        document.getElementById('gameover-screen').classList.remove('visible');
        document.getElementById('leaderboard-screen').classList.add('visible');
        renderLeaderboardScreen((name || 'ANON').slice(0, 12).toUpperCase());
      });
      document.getElementById('play-again-btn').addEventListener('click', () => {
        if (document.getElementById('play-again-btn').dataset.mode === 'back') {
          document.getElementById('gameover-screen').classList.remove('visible');
          document.getElementById('leaderboard-screen').classList.remove('visible');
          document.getElementById('welcome-screen').classList.remove('hide');
          restoreGameOverScreen();
          return;
        }
        document.getElementById('gameover-screen').classList.remove('visible');
        document.getElementById('player-name').value = '';
        document.getElementById('welcome-screen').classList.remove('hide');
        restoreGameOverScreen();
      });

      function showLeaderboardOnly() {
        document.getElementById('welcome-screen').classList.add('hide');
        document.getElementById('leaderboard-screen').classList.add('visible');
        renderLeaderboardScreen();
      }
      function restoreGameOverScreen() {
        document.getElementById('final-score').textContent = '0';
        document.getElementById('name-input-wrap').style.display = 'block';
        document.getElementById('submit-score-btn').style.display = 'block';
        document.getElementById('play-again-btn').textContent = t('play_again');
        document.getElementById('play-again-btn').dataset.mode = '';
      }
      function renderLeaderboardScreen(currentName) {
        var entries = getLeaderboard();
        var html = entries.map(function(e, i) {
          var cls = 'lb-entry' + (i < 3 ? ' top3' : '') + (currentName && e.name === currentName ? ' current' : '');
          return '<div class="' + cls + '">' + (i + 1) + '. ' + e.name + ' <span>' + e.score + '</span></div>';
        }).join('') || '<div class="lb-entry">' + t('no_scores_yet') + '</div>';
        document.getElementById('leaderboard-screen-entries').innerHTML = html;
      }
      document.getElementById('welcome-play-btn').addEventListener('click', function() {
        document.getElementById('welcome-screen').classList.add('hide');
        if (getLang() === null) {
          document.getElementById('language-screen').classList.add('visible');
        } else {
          currentLang = getLang();
          applyTranslations();
          document.getElementById('how-to-play-screen').classList.add('visible');
        }
      });
      document.getElementById('lang-en-btn').addEventListener('click', function() {
        setLang('en');
        document.getElementById('language-screen').classList.remove('visible');
        document.getElementById('how-to-play-screen').classList.add('visible');
      });
      document.getElementById('lang-fr-btn').addEventListener('click', function() {
        setLang('fr');
        document.getElementById('language-screen').classList.remove('visible');
        document.getElementById('how-to-play-screen').classList.add('visible');
      });
      document.getElementById('htp-start-btn').addEventListener('click', function() {
        document.getElementById('how-to-play-screen').classList.remove('visible');
        startGame();
      });
      document.getElementById('welcome-scores-link').addEventListener('click', showLeaderboardOnly);
      document.getElementById('lb-rejouer-btn').addEventListener('click', function() {
        document.getElementById('leaderboard-screen').classList.remove('visible');
        document.getElementById('welcome-screen').classList.remove('hide');
      });
      document.getElementById('lb-comment-jouer').addEventListener('click', function() {
        document.getElementById('leaderboard-screen').classList.remove('visible');
        document.getElementById('how-to-play-screen').classList.add('visible');
      });

      function startGame() {
        // Clear key state so no key is stuck from game over / overlay focus
        ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 'W', 'a', 'A', 's', 'S', 'd', 'D', ' ', 'Enter'].forEach(function(key) {
          keys[key] = false;
          keyUsed[key] = false;
        });
        // Blur so document receives key events (buttons/inputs won't trap Arrow keys)
        if (document.activeElement && document.activeElement.blur) document.activeElement.blur();
        var dayLen = DAY_LENGTH_BASE;
        gameState = {
          running: true,
          score: 0,
          day: 1,
          timeRemaining: dayLen,
          currentDayLength: dayLen,
          koala: { x: WW / 2 - TILE / 2, y: WH / 2 - TILE / 2, gx: 0, gy: 0, w: TILE, h: TILE, walkFrame: 0, lastDir: 'down' },
          families: [],
          bungalows: [],
          showDayTransition: false,
          gameWon: false,
          gameLost: false,
          toastUntil: 0,
          combo: 0,
          multiplierUntil: 0
        };
        spawnBungalows();
        seedFamilies(6);
        document.getElementById('score-display').textContent = t('score_label') + ': 0';
        document.getElementById('day-display').textContent = t('day') + ' 1';
        document.getElementById('time-display').textContent = '1:30';
        document.getElementById('occupied-display').textContent = '0/' + gameState.bungalows.length;
        document.getElementById('how-to-play-screen').classList.remove('visible');
        var prog = document.getElementById('game-progress-wrap');
        if (prog) prog.style.display = 'block';
      }

      document.getElementById('start-btn').addEventListener('click', () => {
        document.getElementById('start-screen').style.display = 'none';
        startGame();
      });

      const SPEED = 4;
      function update() {
        if (!gameState.running) return;

        if (gameState.showDayTransition) return;

        const k = gameState.koala;
        if (keys['ArrowUp'] || keys['w'] || keys['W']) {
          k.y = Math.max(0, k.y - SPEED);
          k.walkFrame = (k.walkFrame + 1) % 20;
          k.lastDir = 'up';
        }
        if (keys['ArrowDown'] || keys['s'] || keys['S']) {
          k.y = Math.min(WH - TILE, k.y + SPEED);
          k.walkFrame = (k.walkFrame + 1) % 20;
          k.lastDir = 'down';
        }
        if (keys['ArrowLeft'] || keys['a'] || keys['A']) {
          k.x = Math.max(0, k.x - SPEED);
          k.walkFrame = (k.walkFrame + 1) % 20;
          k.lastDir = 'left';
        }
        if (keys['ArrowRight'] || keys['d'] || keys['D']) {
          k.x = Math.min(WW - TILE, k.x + SPEED);
          k.walkFrame = (k.walkFrame + 1) % 20;
          k.lastDir = 'right';
        }
        k.gx = Math.floor(k.x / TILE);
        k.gy = Math.floor(k.y / TILE);

        if ((keys[' '] || keys['Enter']) && !keyUsed[' '] && !keyUsed['Enter']) {
          keyUsed[' '] = true;
          keyUsed['Enter'] = true;
          assignFamily();
        }

        gameState.timeRemaining -= 1 / 60;
        if (gameState.timeRemaining <= 0 && !gameState.showDayTransition) endDay();

        const occupied = gameState.bungalows.filter(b => b.occupied).length;
        const total = gameState.bungalows.length;
        const t = Math.max(0, gameState.timeRemaining);
        const mins = Math.floor(t / 60);
        const secs = Math.floor(t % 60);

        document.getElementById('score-display').textContent = t('score_label') + ': ' + gameState.score;
        document.getElementById('day-display').textContent = t('day') + ' ' + gameState.day;
        document.getElementById('time-display').textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
        document.getElementById('occupied-display').textContent = occupied + '/' + total;
        const cf = getCurrentFamily();
        var sizeEl = document.getElementById('current-family-size');
        var peopleEl = document.getElementById('current-family-people');
        var n = cf ? cf.size : 0;
        if (peopleEl.dataset.count !== String(n)) {
          peopleEl.dataset.count = n;
          peopleEl.innerHTML = '';
          if (n > 0) {
            for (var i = 0; i < n; i++) {
              var im = document.createElement('img');
              im.src = 'assets/people.png';
              im.alt = '';
              peopleEl.appendChild(im);
            }
          }
        }
        sizeEl.textContent = n ? n : '-';

        if (gameState.toastUntil > 0 && performance.now() > gameState.toastUntil) {
          document.getElementById('win-lose-toast').classList.remove('show');
        }

        var progWrap = document.getElementById('game-progress-wrap');
        var progFill = document.getElementById('game-progress-fill');
        if (progWrap && progFill && gameState.currentDayLength > 0) {
          var pct = Math.max(0, Math.min(1, gameState.timeRemaining / gameState.currentDayLength));
          progFill.style.width = (pct * 100) + '%';
        }
        var multEl = document.getElementById('game-multiplier');
        if (multEl) {
          if (gameState.combo >= 2 && performance.now() < gameState.multiplierUntil) multEl.classList.add('show');
          else multEl.classList.remove('show');
        }
      }

      var pathCache = null;
      function buildPaths() {
        var pad = 20;
        var L = pad, R = WW - pad, T = pad, B = WH - pad;
        var segs = [];
        function r(lo, hi) { return lo + Math.random() * (hi - lo); }
        var stepH = 100 + Math.random() * 40;
        var stepV = 100 + Math.random() * 40;
        var curveStrength = 50;
        for (var y = T; y <= B; y += stepH) {
          var n = 4 + Math.floor(Math.random() * 2);
          var pts = [];
          var vy = y;
          for (var i = 0; i <= n; i++) {
            var tx = L + (R - L) * i / n + r(-12, 12);
            if (i > 0 && i < n) vy += r(-curveStrength, curveStrength);
            pts.push([tx, vy]);
          }
          var curves = [];
          for (var j = 1; j < pts.length; j++) {
            var p0 = pts[j - 1], p1 = pts[j];
            curves.push([(p0[0] + p1[0]) / 2 + r(-40, 40), (p0[1] + p1[1]) / 2 + r(-40, 40), p1[0], p1[1]]);
          }
          segs.push({ m: [pts[0][0], pts[0][1]], q: curves });
        }
        for (var x = L; x <= R; x += stepV) {
          var n = 4 + Math.floor(Math.random() * 2);
          var pts = [];
          var vx = x;
          for (var i = 0; i <= n; i++) {
            var ty = T + (B - T) * i / n + r(-12, 12);
            if (i > 0 && i < n) vx += r(-curveStrength, curveStrength);
            pts.push([vx, ty]);
          }
          var curves = [];
          for (var j = 1; j < pts.length; j++) {
            var p0 = pts[j - 1], p1 = pts[j];
            curves.push([(p0[0] + p1[0]) / 2 + r(-40, 40), (p0[1] + p1[1]) / 2 + r(-40, 40), p1[0], p1[1]]);
          }
          segs.push({ m: [pts[0][0], pts[0][1]], q: curves });
        }
        return segs;
      }
      function drawPaths() {
        if (!pathCache) pathCache = buildPaths();
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 22;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.beginPath();
        pathCache.forEach(function(s) {
          ctx.moveTo(s.m[0], s.m[1]);
          if (s.q) s.q.forEach(function(q) { ctx.quadraticCurveTo(q[0], q[1], q[2], q[3]); });
        });
        ctx.stroke();
      }

      function getCamera() {
        var k = gameState.koala;
        var camX = Math.max(0, Math.min(WW - CW, k.x - CW / 2 + TILE / 2));
        var camY = Math.max(0, Math.min(WH - CH, k.y - CH / 2 + TILE / 2));
        return { x: camX, y: camY };
      }

      function draw() {
        var cam = getCamera();
        ctx.save();
        ctx.translate(-cam.x, -cam.y);

        ctx.fillStyle = '#e8dcc8';
        ctx.fillRect(0, 0, WW, WH);
        drawPaths();

        if (images.sun && images.sun.complete && images.sun.naturalWidth) {
          ctx.drawImage(images.sun, WW - 80, 8, 64, 64);
        }
        if (images.bush && images.bush.complete) {
          ctx.drawImage(images.bush, 8, WH - 48, 48, 48);
          ctx.drawImage(images.bush, WW - 56, WH - 48, 48, 48);
          ctx.drawImage(images.bush, 200, 360, 48, 48);
          ctx.drawImage(images.bush, 780, 200, 48, 48);
        }

        gameState.bungalows.forEach(b => {
          var img = b.occupied && images.houseFull && images.houseFull.complete ? images.houseFull : images.houseEmpty;
          if (img && img.complete && img.naturalWidth) {
            ctx.drawImage(img, b.x, b.y, b.w, b.h);
          } else {
            ctx.fillStyle = b.occupied ? '#6b8e6a' : '#7a9c8a';
            ctx.fillRect(b.x, b.y, b.w, b.h);
          }
          var num = String(b.beds);
          var badgeW = 28;
          var badgeH = 22;
          var badgeX = b.x + b.w / 2 - badgeW / 2;
          var badgeY = b.y + b.h - 8;
          ctx.fillStyle = '#ffffff';
          ctx.strokeStyle = '#1a3516';
          ctx.lineWidth = 2;
          ctx.fillRect(badgeX, badgeY, badgeW, badgeH);
          ctx.strokeRect(badgeX, badgeY, badgeW, badgeH);
          ctx.font = 'bold 14px "Press Start 2P"';
          ctx.fillStyle = '#1a3516';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(num, b.x + b.w / 2, badgeY + badgeH / 2);
          ctx.textAlign = 'left';
          ctx.textBaseline = 'alphabetic';
        });

        var k = gameState.koala;
        var koalaImg = (k.walkFrame < 10 && images.koalaWalk && images.koalaWalk.complete) ? images.koalaWalk : images.koalaStill;
        if (koalaImg && koalaImg.complete && koalaImg.naturalWidth) {
          ctx.drawImage(koalaImg, k.x, k.y, k.w, k.h);
        } else {
          ctx.fillStyle = '#8b9c7a';
          ctx.fillRect(k.x, k.y, k.w, k.h);
        }
        var fam = getCurrentFamily();
        if (fam && images.people && images.people.complete) {
          var followDist = 20;
          var size = 18;
          var dir = k.lastDir || 'down';
          var dx = 0, dy = 0;
          if (dir === 'up') dy = followDist;
          if (dir === 'down') dy = -followDist;
          if (dir === 'left') dx = followDist;
          if (dir === 'right') dx = -followDist;
          var baseX = k.x + k.w / 2 + dx - size / 2;
          var baseY = k.y + k.h / 2 + dy - size / 2;
          var stepX = 0, stepY = 0;
          if (dir === 'up' || dir === 'down') stepY = dir === 'up' ? size + 4 : -(size + 4);
          else stepX = dir === 'right' ? -(size + 4) : size + 4;
          for (var i = 0; i < fam.size; i++) {
            var px = baseX + stepX * i;
            var py = baseY + stepY * i;
            ctx.drawImage(images.people, px, py, size, size);
          }
        }
        ctx.restore();
      }

      function loop() {
        update();
        draw();
        requestAnimationFrame(loop);
      }

      loadImages(() => {
        loop();
      });
    })();
  </script>
</body>
</html>
